카프카 스트림즈
==

카프카 스트림즈 : 토픽에 적재된 데이터를 상태기반(Stateful) or 비상태기반(Stateless)으로 실시간 변환하여 다른 토픽에 적재하는 라이브러리이다.

아파치 스파크, 아파치 플링크, 아파치 스톰, 플루언트디가 카프카 스트림즈와 비슷하게 스트림 데이터처리를 위해 사용됨.

- 스트림 처리에 필요한 기능(신규 토픽 생성, 상태 저장, 데이터 조인 등)을 제공함.
- 장애 허용 시스템을 가지고 있어 데이터 처리 안정성이 매우 뛰어남
- 실시간 스트림 처리를 해야하는 필요성이 있다면 카프카 스트림즈를 1순위로.

보통의 빅데이터 처리인 분산 시스테밍나 스케줄링 프로그램은 스트림즈를 운영하는데에는 불필요함.
JVM 위에서 하나의 프로세스로 실행됨.

> 프로듀서와 컨슈머를 조합해서 사용하지 않고 스트림즈를 사용해야 하는 이유
> 필요한 기능을 스트림즈 DSL로 제공하고 프로세서 API를 사용하여 확장이 가능하기 때문.
> 단 한번의 데이터 처리 & 장애 허용 시스템 등의 특징은 프로듀서+컨슈머의 조합만으로 완벽하게 구현이 어려움. 

스트림즈의 태스크(task)는 데이터 처리 최소 단위이다. <br>
3개의 파티션으로 이루어진 토픽을 처리하는 스트림즈 애플리케이션을 실행하면 내부에 3개의 태스크가 생김.

컨슈머 스레드를 늘리는 방법과 동일하게 병렬처리를 위해 파티션과 스티림즈 스레드 개수를 늘림으롰 처리량을 늘릴 수 있다.

실제 운영환경에서는 안정적인 운영을 위해 2개 이상의 서버로 구성하여 스트림즈 애플리케이션을 운영한다.

>토폴로지(topology)
2개 이상의 노드들과 선으로 이루어진 집합.<br>
ring, tree, star 형이 있는데, 스트림즈에서 사용하는 로폴로지는 tree와 유사함.

카프카 스트림즈에서는 토폴로지를 이루는 노드를 하나의 '프로세서'라고 부르고 노드와 노드를 이은 선은 '스트림'이라고 부른다.

스트림은 토픽의 데이터를 뜻하고, 프로듀서와 컨슈머에서 활용했던 레코드와 동일함.

1. 소스 프로세서 : 데이터를 처리하기 위해 최초로 선언해야하는 노드. 하나 이상의 토픽에서 데이터를 가져오는 역할을 함. 
2. 스트림 프로세서 : 다른 프로세서가 반환한 데이터를 처리하는 역할. 변환 분기처리와 같은 로직이 데이터 처리의 일종.
3. 싱크 프로세서 : 데이터를 특정 카프카 토픽으로 저장하는 역할. 최종 종착지.


> 스트림즈 DSL로 구현하는 데이터 처리
> - 메시지 값을 기반으로 토픽 분기 처리
> - 10분간 들어온 데이터의 개수 집계
> - 토픽과 다른 토픽의 결합으로 새로운 데이터 생성

> 프로세서 API로 구현하는 데이터 처리 
> - 메시지 값의 종류에 따라 토픽을 가변적으로 전송
> - 일정한 시간 간격으로 데이터 처리

KStream
--
- 레코드의 흐름은 표현한 것으로 메시지 키와 값으로 구성되어 있음.
- 토픽에 존재하는 모든 레코드가 출력됨.

KTable
--
- 메시지 키를 기준으로 묶어서 사용. 
- 유니크한 키를 기준으로 가장 최신 레코드를 사용함.
- 가장 최신에 추가된 레코드의 데이터가 출력되고 동일한 메시지 키가 있을경우 데이터가 업데이트.

GlobalKTable
--
- KTable과 비슷하지만 1개의 파티션과 1개의 태스크에 할당되는 것과 달리, 선언된 토픽은 모든 파이션 데이터가 각 태스크에 할당됨.
- 데이터 조인을 수행할 때 쓰임
- KStream과 KTable의 메시지 키가 동일할 경우 조인을 수행할 수 있음.(코파티셔닝)
- 그렇지 않다면 조인을 수행할 수 없음(TopologyException 발생.) -> 리파티셔닝을 통해 키를 맞춰주면 가능.
- 코파티셔닝이 되어 있지 않은 KStream과 KTable을 조인하려면 KTable을 GlobalKTable로 선언해서 사용하면 조인가능.
  (모든 태스크에 동일하게 공유되어 사용되기 때문..)
- 로컬 스토리지 사용량이 증가하고 네트워크, 브로커에 부하가 생기므로 되도록 적은 용량의 데이터일 경우에만 사용.

스트림즈 DSL 주요 옵션
--

>필수옵션
- bootstrap.servers
- application.id

>선택옵션
- default.key.serde : 직렬화, 역직렬화
- default.value.serde : 직렬화, 역직렬화
- num.stream.threads : 스레드 개수 지정
- state.dir : rocksDB 저장소 디렉토리 지정

스트림즈DSL - stream(), to()
--
특정 토픽의 데이터를 다른 토픽으로 전달.

스트림즈DSL - filter()
--
메시지 키 또는 메시지 값을 필터링하여 특정 조건에 맞는 데이터를 골라 낼때는 filter() 메서드를 사용.<br>
filter는 필터링 스트림 프로세서. 

스트림즈DSL - KTABLE과 KSTREAM을 join()
--

스트림즈DSL - GlobalKTABLE과 KSTREAM을 join()
--
