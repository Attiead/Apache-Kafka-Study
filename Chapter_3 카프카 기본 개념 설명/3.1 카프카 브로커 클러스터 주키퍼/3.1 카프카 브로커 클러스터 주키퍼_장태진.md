
카프카 브로커<br>
- 카프카 클라이언트와 데이터를 주고 받기 위해 사용하는 주체.
- 데이터를 분산 저장하여 장애가 발생하더라도 안전하게 사용할 수 있도록 도와주는 애플리케이션
- 하나의 서버에는 한 개의 카프카 브로커 프로세스가 실행된다.<br>
  (최소 3대 이상의 서버를 1개의 클러스터로 묶어야 안전)
- 프로듀서가 보낸 데이터를 안전하게 분산 저장하고 복제하는 역할


데이터 저장, 전송
--
프로듀서로 부터 데이터를 전달받으면 브로커는 프로듀서가 요청한 토픽의 파티션에 데이터를 저장.<br>
컨슈머가 데이터를 요청하면 파티션에 저장된 데이터를 전달함.<br>
프로듀서로부터 전달된 데이터는 파일 시스템에 저장됨.

속도<br>
파일 시스템은 다루기 편하지만 지속적으로 입출력할 경우 메모리에 올려서 사용하는 것보다 처리 속도가 느림.<br>
카프카는 page cache로 이를 해결했음. <br>
cache를 사용하지 않았다면 cache를 직접 구현해야했고, 지속적으로 변경되는 데이터 때문에 GC가 자주 일어나 속도가 느려졌을 것.<br>
heap memory size를 크게 설정안해도 됨.

데이터 복제, 싱크
--
replication은 데이터를 유실하지 않고 안전하게 사용하게 해주는 원동력임.

- 카프카의 데이터 복제는 파티션단위로 이뤄짐.
- 토픽 생성시 파티션의 복제 개수도 같이 설정됨.(default는 브로커에 설정된 옵션값)
- 최솟값은 1(복제없음)
- 파티션은 leader & follower로 구성됨. 
leader : 프로듀서 또는 컨슈머와 직접 통신하는 파티션<br>
follower : 복제데이터를 가지고 있는 파티션

팔로워는 리더의 오프셋을 확인하여 현재 자신이 가지고 있는 옵셋과 차이가 나는 경우 리더에서 데이터를 가져옴.<br>
-> 이 과정이 복제.

리더가 장애가 나면, 팔로워 중 하나가 리더의 지위를 넘겨받는다. <br>
데이터가 유실되어도 무관하고 데이터 처리속도가 중요하다면 복제 개수는 1 or 2로 설정한다.

컨트롤러
--
클러스터의 다수 브로커 중 한대가 컨트롤러 역할을 함.<br>
다른 브로커들의 상태를 체크하고, 장애시 리더 파티션을 재분재함. <br>
컨트롤러가 비정상이라면 다른 브로커가 컨트롤러 역할을 한다. 

데이터 삭제
--
컨슈머가 데이터를 가져가더라도 토픽의 데이터는 삭제되지 않음. <br>
컨슈머나 프로듀서가 데이터 삭제도 요청 못함.

오직 브로커만이 데이터 삭제 가능. 

로그 세그먼트(log segment) : 데이터 삭제는 파일 단위로 이뤄진다. 해당 단위를 뜻한다.<br>

세그먼트에는 다수의 데이터가 들어있어 일반 db처럼 특정 데이터를 선별하여 삭제 불가.<br>
데이터가 쌓이는 동안 파일 시스템으로 열려있으며 log.segment.bytes or log.segment.ms 옵션에 <br>
값이 설정되면 세그먼트 파일이 닫힘.(기본은 1GB용량에 도달했을 때 닫힘. 추가 설정 가능)

닫힌 세그먼트 파일은 log.retention.bytes or log.retention.ms 옵션에 설정값이 넘으면 삭제됨.<br>
닫힌 세그먼트 파일을 체크하는 간격은 log.retention.check.interval.ms에 따름.


컨슈머 오프셋 저장
--
컨슈머 그룹은 토픽이 특정 파티션으로부터 데이터를 가져가서 처리하고 어느 레코드까지 가져갔는지 오프셋을 커밋함.<br>
(__consumer_offsets)


코디네이터
--
브로커 중 한대는 코디네이터 역할 수행함.<br>
컨슈머 그룹의 상태를 체크하고 파티션을 컨슈머와 매칭되도록 분배하는 역할.<br>
rebalance를 수행함.

rebalance : 컨슈머가 그룹에서 빠지면 매칭되지 않은 파티션을 정상동작하는 컨슈머로 할당해서 끊임없이 데이터 처리가 이뤄지게 함.


주키퍼
--
카프카의 메타데이터를 관리하는데 사용됨.<br>
기본 포트 2181<br>
(쉘 명령어 : zookeeper-shell.sh 로 어떤 데이터(znode)를 저장하는지 확인가능)


주키퍼에서 다수의 카프카 클러스터를 사용하는 방법<br>
root znode가 아닌 한 단계 아래의 znode를 브로커 옵션으로 지정함.
- zookeeper.connect=localhost:2181/pipeline
- zookeeper.connect=localhost:2181/recommend


