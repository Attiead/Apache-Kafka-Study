### 카프카 프로듀서
* 소개
  * 카프카에서 데이터를 저장하는 첫 단계
  * 프로듀서에서 다양한 옵션을 카프카 클러스터에 제공
##### acks(acknowledgements) 옵션
* 소개
  * producer가 메시지를 보내고 나서 broker로 부터 받을 수 있는 확인 응답의 수를 조절하는 역할.
  * 메시지가 성공적으로 broker에 전달되었는지 여부를 결정하고, 이 옵션의 값에 따라 메시지 전송의 안전성과 성능이 조절됨
  * acks 옵션은 0, 1, all(또는 -1) 값을 가질 수 있음
  * 복제 개수가 1인 경우, acks 옵션에 따른 성능 변화는 크지 않기 때문에 복제 개수가 2 이상인 경우의 acks별 동작 방식을 살펴봄
---
* acks=0
  * 프로듀서가 리더 파티션으로 데이터를 전송했을 때 리더 파티션으로 데이터가 저장되었는지 확인하지 않는다는 뜻.
  * 리더파티션(기본동작) : 데이터가 저장된 이후에 데이터가 몇 번째 오프셋에 저장되었는지 리턴.
    * 그러나 acks가 0이면 프로듀서는 리더 파티션에 데이터가 저장되었는지 여부에 대한 응답 값을 받지 않고, 데이터가 몇 번째 오프셋에 저장되었는지 확인할 수 없음.
    * 프로듀서와 브로커 사이에서 데이터가 유실되더라도, 응답값을 받지 않기 때문에 지속적으로 다음 데이터를 보냄
    * 데이터가 유실되더라도 전송 속도가 중요한 경우에 사용
* acks=1
  * 프로듀서는 보낸 데이터가 리더 파티션에만 정상적으로 적재되었는지 확인함.
  * 리더 파티션에 적재될 때까지 재시도 할 수 있으며, 팔로워 파티션이 데이터를 복제하기 직전에 리더 파티션이 있는 브로커에 장애가 발생하면 동기화되지 못한 일부 데이터가 유실될 수 있음
  * acks가 0일 때보다 전송 속도가 느림
* acks=all 또는 acks=-1
  * 프로듀서는 보낸 데이터가 리더 파티션과 팔로워 파티션에 모두 정상적으로 적재되었는지 확인
  * 모두 확인하기 때문에 0또는 1 옵션보다 속도가 느림
  * 팔로워 파티션에 데이터가 정상 적재되었는지 기다리기 때문에 일부 브로커에 장애가 발생하더라고 프로듀서는 안전하게 데이터를 전송하고 저장할 수 있음을 보장함
  * 설정 시 고려해야 할 점
    * min.insync.replicas 옵션
      * all 옵션 값은 모든 리더 파티션과 팔로워 파티션의 적재를 뜻하는것이 아닌 ISR에 포함된 파티션을 뜻함.
      * 프로듀서가 리더 파티션과 팔로워 파티션에 데이터가 적재되었는지 확인하기 위한 최소 ISR그룹의 파티션 개수(따라서 이 설정이 1이면 리더 파티션만 해당하고 acks=1인 경우와도 동일)
      * 이 설정은 복제 개수도 함께 고려해야 함
        * 복제 개수=3, min.insync.replicas=3 이면 브로커 3대 중 1대에 이슈가 생기면 최소한으로 복제되어야 하는 파티션 개수가 3인데 팔로워 파티션이 위치할 브로커의 개수가 부족하여 데이터를 해당 토픽에 전송할 수 없는 상황
    * 상용환경에서는 일반적으로 브로커를 3대 이상으로 묶어 클러스터를 운영하므로, 프로듀서가 데이터를 가장 안정적으로 보내려면 
      * 토픽의 복제 개수=3, min.insync.replicas=2, acks=all 추천
##### 멱등성(idempotence) 프로듀서
* 멱등성 프로듀서는 동일한 데이터를 여러번 전송하더라고 카프카 클러스터에 단 한 번만 저장
* 프로듀서의 동작 방식
  * at least once deliver(기본프로듀서) : 적어도 한 번 전달, 두 번 이상 적재할 가능성이 있으므로 데이터의 중복이 발생할 수 있음
  * exactly once delivery(멱등성프로듀서) : 동일한 세션에서 정확히 한 번 전달 (enable.idempotence=true로 설정함)
  * 멱등성 프로듀서 데이터 전달 과정
    * 멱등성 프로듀서는 기본 프로듀서와 달리 데이터를 브로커로 전달할 때 프로듀서 PID(Producer unique ID)와 시퀀스 넘버(sequence number)를 함께 전달
    * 그러면 브로커는 위 두 정보를 확인하여 동일한 메시지의 적재요청이 오더라도 단 한 번만 데이터를 적재함
    * '동일한 세션' = PID의 생명주기를 뜻함 (애플리케이션을 재시작하면 PID가 달라짐)
    * 시퀀스 넘버는 0부터 시작하여 1씩 더한 값이 전달되기때문에 브로커가 시퀀스 번호를 예상할 수 있다. 그런데 예상한 번호가 아닐 경우 OutOfOrderSequenceException이 발생하게 됨
---
##### 트랜잭션(transaction) 프로듀서
* 카프카의 트랜잭션 프로듀서느 다수의 파티션에 데이터를 저장할 경우 모든 데이터에 대해 동일한 원자성(atomic)을 만족시키기 위해 사용
* 원자성을 만족시킨다라는 의미 : 다수의 데이터를 동일 트랜잭션으로 묶음으로써 전체 데이터를 처리하거나 전체 데이터를 처리하지 않도록 하는 것을 의미
* 트랜잭션은 파티션의 레코드로 구분
  * 어떻게?
    * 트랜잭션 프로듀서 -> 사용자가 보낸 데이터를 레코드로 파티션에 저장 + 트랜잭션의 시작과 끝을 표현하기 위해 트랜잭션 레코드를 한 개 더 보냄
      * 트랜잭션 레코드 : 실질적인 데이터는 없고, 트랜잭션이 끝난 상태를 표시한 정보만 있음. 오프셋은 하나 차지함
    * 트랜잭션 컨슈머 -> 커밋이 완료된 데이터가 파티션에 있을 경우에만 데이터를 가져감